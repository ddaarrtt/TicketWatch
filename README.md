



<img src="https://capsule-render.vercel.app/api?type=waving&color=3F51B5&height=300&section=header&text=âš¾TicketWatchâš¾&fontSize=70&fontColor=FFFFFF&animation=fadeIn&width=1200" width="1200" />

## ğŸš©ê°œìš”
**ì•¼êµ¬ í‹°ì¼“íŒ… ì‹œìŠ¤í…œì˜ ëª¨ë‹ˆí„°ë§ í™˜ê²½ì„ êµ¬ì¶•**í•˜ëŠ” í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤. <br>
ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ì‹œìŠ¤í…œì˜ í•œê³„ë¥¼ íŒŒì•…í•˜ê³ , **ì¥ì•  ìƒí™©ì— ëŒ€ë¹„í•  ìˆ˜ ìˆëŠ” ì•ˆì •ì ì¸ ìš´ì˜ í™˜ê²½**ì„ ë§ˆë ¨í•©ë‹ˆë‹¤. <br>
ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê°œì„  ë°©í–¥ì„ ë¶„ì„í•©ë‹ˆë‹¤.


<br>

## ğŸ“ Outline
- [1ï¸âƒ£ Contributors](#1%EF%B8%8Fâƒ£-contributors)
- [2ï¸âƒ£ Contents](#2%EF%B8%8Fâƒ£-contents)
- [3ï¸âƒ£ Performance Optimization](#3%EF%B8%8Fâƒ£-performance-optimization)
- [4ï¸âƒ£ Trouble Shooting](#4%EF%B8%8Fâƒ£-trouble-shooting)

<br>
<br>


## ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Contributors
<br>

| <img src="https://github.com/kcs19.png" width="200px"> | <img src="https://github.com/HongChan1412.png" width="200px"> | <img src="https://github.com/letmeloveyou82.png" width="200px"> | <img src="https://github.com/nanahj.png" width="200px"> |
| :---: | :---: | :---: | :---: |
| [ê¹€ì°½ì„±](https://github.com/kcs19) | [ë‚˜í™ì°¬](https://github.com/HongChan1412) | [ìµœìœ¤ì •](https://github.com/letmeloveyou82) | [ì´í˜„ì •](https://github.com/nanahj) |


<br>


<br>

## ğŸ¥… ëª©í‘œ

1. **Grafana & Prometheus ê¸°ë°˜ì˜ ëª¨ë‹ˆí„°ë§ ì„œë²„ êµ¬ì¶•**
    - ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ì‹œê°í™”ë¥¼ í†µí•´ ì‹œìŠ¤í…œ ìƒíƒœë¥¼ ì§ê´€ì ìœ¼ë¡œ íŒŒì•…í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í•©ë‹ˆë‹¤.
    
2. **Exporter ì—°ë™ì„ í†µí•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ìì› ëª¨ë‹ˆí„°ë§**
    - ê° ì„œë²„ ë° ì• í”Œë¦¬ì¼€ì´ì…˜ì— Exporterë¥¼ ì„¤ì¹˜í•˜ì—¬ CPU, ë©”ëª¨ë¦¬, íŠ¸ë˜í”½ ë“±ì˜ ë¦¬ì†ŒìŠ¤ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
    
3. **ì‹¤ì „ ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜ì˜ ë¶€í•˜ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰**
    - ì‹¤ì œ í‹°ì¼“íŒ… ìƒí™©ì„ ë°˜ì˜í•œ HTTP ë° DB ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ ì„¤ê³„ ë° ì‹¤í–‰í•˜ì—¬ ì‹œìŠ¤í…œ ë‚´êµ¬ì„±ì„ ì ê²€í•©ë‹ˆë‹¤.
        - ìë¦¬ ì¡°íšŒ (GET /seats)
        - ìë¦¬ ì˜ˆì•½ (POST /book)

<br>

## **ğŸ‘¨â€ğŸ’» ê¸°ìˆ  ìŠ¤íƒ**

| ì—­í•  | ì¢…ë¥˜ |
| --- | --- |
| ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ | ![MySQL](https://img.shields.io/badge/MySQL-4479A1.svg?style=for-the-badge&logo=mysql&logoColor=white) |
| ğŸ› ï¸ ë°±ì—”ë“œ | ![Spring Boot](https://img.shields.io/badge/SpringBoot-6DB33F.svg?style=for-the-badge&logo=spring-boot&logoColor=white) |
| ğŸ‘€ ëª¨ë‹ˆí„°ë§ | ![Grafana](https://img.shields.io/badge/Grafana-F46800.svg?style=for-the-badge&logo=grafana&logoColor=white) |
| ğŸ“Š ë°ì´í„° ìˆ˜ì§‘ | ![Prometheus](https://img.shields.io/badge/Prometheus-E6522C.svg?style=for-the-badge&logo=prometheus&logoColor=white) |
| âš¡ ë¶€í•˜ í…ŒìŠ¤íŠ¸ | ![wrk](https://img.shields.io/badge/wrk-000000.svg?style=for-the-badge&logo=linux&logoColor=white) <br> ![sysbench](https://img.shields.io/badge/sysbench-007ACC.svg?style=for-the-badge&logo=linux&logoColor=white) |
| ğŸ’» ê°€ìƒí™” í”Œë«í¼ | ![VMware](https://img.shields.io/badge/VMware-607078.svg?style=for-the-badge&logo=vmware&logoColor=white) |



<br>

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### âœ… í…ŒìŠ¤íŠ¸ ê°œìš”
- HTTP ë¶€í•˜ ìƒì„± ë„êµ¬ì¸ `wrk`ë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì²­ ì‹œë®¬ë ˆì´ì…˜ ìˆ˜í–‰

### ğŸ“ Step 1. ê²½ê¸° ì¢Œì„ ì¡°íšŒ (Read íŠ¸ë˜í”½)
- ë‹¤ìˆ˜ ì‚¬ìš©ìê°€ ìë¦¬ë¥¼ ì¡°íšŒí•˜ëŠ” ìƒí™©ì„ ì‹œë®¬ë ˆì´ì…˜

```bash
wrk -t4 -c50 -d30s http://<ip>/seats
```

### ğŸ“ Step 2. ì¢Œì„ ì˜ˆë§¤ (Write íŠ¸ë˜í”½)
- ë™ì‹œì— ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ê°™ì€ ì¢Œì„ì„ ì˜ˆë§¤ ì‹œë„
- DBì— `INSERT`, `UPDATE`, `SELECT` íŠ¸ëœì­ì…˜ì´ í˜¼í•©ë˜ì–´ ë°œìƒ

```bash
wrk -t10 -c500 -d30s -s post_book.lua http://<ip>/book
```

#### ğŸ“„ post_book.lua ë‚´ìš©

```lua
wrk.method = "POST"
wrk.headers["Content-Type"] = "application/json"

request = function()
  local seatId = math.random(100, 120)
  local userId = "user" .. math.random(1, 5000)
  local body = string.format('{"seatId":%d,"userId":"%s"}', seatId, userId)
  return wrk.format("POST", "/book", nil, body)
end
```

<br>

## ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë° ê°œì„  ë°©í–¥

### ğŸ–¥ï¸ 1. CPU ì‚¬ìš©ë¥ 
```bash
system_cpu_usage{application="$application", instance="$instance"}
```
![image](https://github.com/user-attachments/assets/ed8b3384-06c8-4a6c-ab86-1bb27a822e20)

- ë¶€í•˜ ì‹œì‘ê³¼ í•¨ê»˜ CPU ì‚¬ìš©ë¥ ì´ 100%ê¹Œì§€ ê¸‰ë“± í›„ ì„œì„œíˆ í•˜ë½  
- **ì„œë²„ì˜ ë¶€í•˜ ê°ë‹¹ í•œê³„ë¥¼ ëª…í™•íˆ í™•ì¸**

**ê°œì„  ë°©í–¥:** ë³‘ë ¬ ì²˜ë¦¬, ìºì‹±, ë¡œë“œë°¸ëŸ°ì‹± ë„ì…



### ğŸ“ 2. ë¡œê·¸ ë°œìƒëŸ‰
```bash
increase(logback_events_total{application="$application", instance="$instance"}[1m])
```
![image](https://github.com/user-attachments/assets/8fae21f2-5fc3-455f-a0cf-96e5cad75f19)

- ë¡œê·¸ëŠ” `1 ops/m` ìˆ˜ì¤€ìœ¼ë¡œ ì¼ì •í•˜ê²Œ ë°œìƒ  
- ì˜ˆì™¸ ë°œìƒ ì‹œ ë¡œê·¸ê°€ ì •ìƒì ìœ¼ë¡œ ê¸°ë¡ë˜ì–´ **ì—ëŸ¬ ë°œìƒ ì‹œì ì„ í™•ì¸í•  ìˆ˜ ìˆìŒ**

**ê°œì„  ë°©í–¥:** ì—ëŸ¬ ë°œìƒ ì‹œê°„ ê¸°ë°˜ ìƒì„¸ ë¶„ì„, ë¡œê·¸ ë ˆë²¨ ë° ë‚´ìš© ì ê²€



### ğŸ’¾ 3. MySQL ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½
```bash
rate(mysql_global_status_bytes_received{instance="$host"}[$interval]) or irate(mysql_global_status_bytes_received{instance="$host"}[5m])
```
![image](https://github.com/user-attachments/assets/b579fc0d-20cb-4115-a617-5c66dd385b50)


- í…ŒìŠ¤íŠ¸ ì¤‘ DB ìˆ˜ì‹  íŠ¸ë˜í”½ ì•½ `700kB/s` ë°œìƒ  
- ì´ëŠ” ì‚¬ìš©ì ìš”ì²­ì´ **DBê¹Œì§€ ì „ë‹¬ë˜ì–´ ì²˜ë¦¬ë˜ê³  ìˆìŒì„ ì˜ë¯¸**

**ê°œì„  ë°©í–¥:** ì¿¼ë¦¬ ìµœì í™” ë° ì¸ë±ìŠ¤ ì ìš© ê²€í† , ì—°ê²° í’€ ê´€ë¦¬ ë° DB ì„¸ì…˜ íŠœë‹



### ğŸŒ 4. HTTP ì‘ë‹µ ìƒíƒœ ë¶„ì„
```bash
http_server_requests_seconds_count
```
![image](https://github.com/user-attachments/assets/c11e1d14-6051-4189-87a9-249531b16735)

- 200 OKê°€ ëŒ€ë¶€ë¶„ì´ì§€ë§Œ, **504 Gateway Timeout** ë° **409 Conflict** ì˜¤ë¥˜ ë‹¤ìˆ˜ ë°œìƒ

**ê°œì„  ë°©í–¥:** ì„œë²„ íƒ€ì„ì•„ì›ƒ ì„¤ì • ì¬ì¡°ì •, ì¤‘ë³µ ìš”ì²­ ë°©ì§€ ë¡œì§ ë„ì…, DB ë½ ì „ëµ ì ìš© (ë¹„ê´€ì /ë‚™ê´€ì  ë½), ìš”ì²­ í í˜¹ì€ ì˜ˆì•½ ë¡œì§ ë³´ì™„



<br>

## ğŸ“Œ ì¢…í•© ê²°ë¡  ë° ê°œì„  ìš”ì•½

| í•­ëª© | ë¬¸ì œ í˜„ìƒ | ì›ì¸ ë¶„ì„ | ê°œì„  ë°©ì•ˆ |
|------|------------|------------|------------|
| **CPU** | ë¶€í•˜ ì‹œ 100% ê¸‰ë“± | ë³‘ë ¬ ì²˜ë¦¬ ë¶€ì¡± | ë©€í‹°ìŠ¤ë ˆë”©, ìºì‹±, ë¡œë“œë°¸ëŸ°ì‹± ë„ì… |
| **ë¡œê·¸** | ì˜ˆì™¸ ë°œìƒ ì‹œ ìƒì„± | ì •ìƒ ë¡œê¹… ë™ì‘ | ì—ëŸ¬ ë¡œê·¸ ë¶„ì„, ë ˆë²¨ ì¡°ì • |
| **DB** | íŠ¸ë˜í”½ ì¦ê°€ | ìš”ì²­ ì •ìƒ ì²˜ë¦¬ | ì¿¼ë¦¬ ìµœì í™”, ì¸ë±ìŠ¤ ê²€í†  |
| **HTTP ì‘ë‹µ** | 504, 409 ì˜¤ë¥˜ ë‹¤ìˆ˜ | ë™ì‹œ ìš”ì²­ ì¶©ëŒ, íƒ€ì„ì•„ì›ƒ | ë½ ì²˜ë¦¬ ì „ëµ, UX ë³´ì™„, ì„œë²„ ì„¤ì • íŠœë‹ |

---

ì´ë²ˆ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ì‹¤ì œ íŠ¸ë˜í”½ ìƒí™©ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë³‘ëª© ì§€ì ì„ ì‚¬ì „ì— íŒŒì•…í•  ìˆ˜ ìˆì—ˆìœ¼ë©°, í–¥í›„ ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ ëª…í™•í•œ ê°œì„  ë°©í–¥ì„ ë„ì¶œí•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.  


<br>

## ğŸš€ Trouble Shooting
### wrk ê²°ê³¼ë¡œ timeoutì´ ë“±ì¥í–ˆëŠ”ë°, Grafanaì—ì„œëŠ” í™•ì¸í•  ìˆ˜ ì—†ëŠ” ì´ìŠˆ
ê¸°ì¡´ Grafana Promql : `sum by (status) (rate(http_server_requests_seconds_count[1m]))`

![image (14)](https://github.com/user-attachments/assets/2fb39892-b518-4c99-8907-ab6bba165ccb)

### 1. ìë°” ì½”ë“œ ìˆ˜ì • controllerì— return í•  ë•Œ timeout 504 status ë¥¼ ì˜ˆì™¸ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë³€ê²½

```java
    @GetMapping("/seats")
    public ResponseEntity<?> getSeats() {
        ExecutorService controllerExecutor = Executors.newSingleThreadExecutor();
        try {
            Future<List<Seat>> future = controllerExecutor.submit(() -> seatService.getAllSeatsParallel());
            List<Seat> seats = future.get(2, TimeUnit.SECONDS); // 2ì´ˆ ë‚´ ë¯¸ì‘ë‹µ ì‹œ timeout ì²˜ë¦¬
            return ResponseEntity.ok(seats);
        } catch (TimeoutException e) {
            log.warn("/seats ìš”ì²­ì—ì„œ TimeoutException ë°œìƒ: ì²˜ë¦¬ ì‹œê°„ ì´ˆê³¼");
            return ResponseEntity.status(HttpStatus.GATEWAY_TIMEOUT).body("ì¡°íšŒ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (Exception e) {
            log.error("/seats ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            controllerExecutor.shutdown();
        }
    }
```

---

### 2. java ì½”ë“œ ìˆ˜ì • í›„ì—ë„ ê·¸ë¼íŒŒë‚˜ì—ì„œ ë³¼ ìˆ˜ ì—†ì–´ ë¡œê·¸ í™•ì¸

```bash
nohup java -jar ticketing-api-0.0.1-SNAPSHOT.jar > logs/app.log 2>&1 &
```

jar íŒŒì¼ ì‹¤í–‰í•œ ê²°ê³¼ë¥¼ log íŒŒì¼ì— ì €ì¥í•˜ë©° nohup ì‚¬ìš©í•´ ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í•˜ì˜€ë‹¤.

![image (15)](https://github.com/user-attachments/assets/ac4fac3d-e553-4b98-93f7-6d7efee56412)

- ë¡œê·¸ì—ëŠ” TimeExceptionì´ ì˜ ì‹¤í–‰ë˜ì—ˆë‹¤ëŠ” ê²ƒì„ í™•ì¸ ê°€ëŠ¥í–ˆë‹¤.

### 3. Prometheusê°€ `504` ìƒíƒœì½”ë“œ ì‘ë‹µì„ ì§„ì§œ ìˆ˜ì§‘í•˜ê³  ìˆëŠ”ì§€ í™•ì¸

- Prometheus ìì²´ UIì— ë“¤ì–´ê°€ì„œ ë©”íŠ¸ë¦­ì„ ìš”ì²­ìˆ˜ì™€ ìƒíƒœ ì½”ë“œ ì§€í‘œë¥¼ ê²€ìƒ‰í–ˆë‹¤.
    
    ```
    http://<IP>:9090
    ```
    
    ### ê²€ìƒ‰ì°½ì— ë©”íŠ¸ë¦­ ì…ë ¥
    
    Prometheus UI ìƒë‹¨ì— ì´ë ‡ê²Œ ì…ë ¥í•˜ê³  ì—”í„°:
    
    ```
    http_server_requests_seconds_count
    ```
    
- ê²€ìƒ‰í•´ë³´ë‹ˆ 504ê°€ ì˜ ì¡í˜”ë‹¤.

![image (16)](https://github.com/user-attachments/assets/09cd845c-d00e-4200-9c34-e0d0a57ba074)


- í•´ë‹¹ promqlì„ Grafanaì—ì„œë„ ì ìš©í–ˆë”ë‹ˆ 504 ì—ëŸ¬ê¹Œì§€ ì‹œê°í™”í•  ìˆ˜ ìˆì—ˆë‹¤.
    
    ![image (17)](https://github.com/user-attachments/assets/185e51d7-e8b0-480e-964d-a78fc51ce611)



<img src="https://capsule-render.vercel.app/api?type=waving&color=3F51B5&height=150&section=footer" width="1000" />
